"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url_1 = require("url");
const debug_1 = require("@hint/utils/dist/src/debug");
const utils_compat_data_1 = require("@hint/utils-compat-data");
const is_regular_protocol_1 = require("@hint/utils/dist/src/network/is-regular-protocol");
const cut_string_1 = require("@hint/utils/dist/src/misc/cut-string");
const normalize_string_1 = require("@hint/utils/dist/src/misc/normalize-string");
const pretty_print_array_1 = require("@hint/utils/dist/src/misc/pretty-print-array");
const meta_1 = require("./meta");
const i18n_import_1 = require("./i18n.import");
const debug = debug_1.debug(__filename);
class DisownOpenerHint {
    constructor(context) {
        let includeSameOriginURLs = false;
        const loadHintConfigs = () => {
            includeSameOriginURLs = (context.hintOptions && context.hintOptions.includeSameOriginURLs) || false;
        };
        const checkForRelValues = (resource, element, relValuesToCheckFor) => {
            const relValues = normalize_string_1.normalizeString(element.getAttribute('rel'), '').split(' ');
            const hrefValue = normalize_string_1.normalizeString(element.getAttribute('href')) || '';
            const requiredValues = relValuesToCheckFor.filter((value) => {
                return !relValues.includes(value);
            });
            if (requiredValues.length !== 0) {
                const message = i18n_import_1.getMessage('shouldHaveRel', context.language, [
                    cut_string_1.cutString(element.outerHTML, 100),
                    pretty_print_array_1.prettyPrintArray(requiredValues),
                    requiredValues.length === 1 ? i18n_import_1.getMessage('keyword', context.language) : i18n_import_1.getMessage('keywords', context.language)
                ]);
                context.report(resource, message, { content: hrefValue, element });
            }
        };
        const checkSameOrigin = (resource, element) => {
            const hrefValue = normalize_string_1.normalizeString(element.getAttribute('href')) || '';
            try {
                const fullURL = new url_1.URL(hrefValue, resource).href;
                if ((new url_1.URL(resource).origin === new url_1.URL(fullURL).origin) && !includeSameOriginURLs) {
                    debug('Is same origin');
                    return false;
                }
                return true;
            }
            catch (e) {
                debug(e);
                return true;
            }
        };
        const hasHrefValue = (element) => {
            if (normalize_string_1.normalizeString(element.getAttribute('href')) !== null) {
                return true;
            }
            debug(`'href' is not specified`);
            return false;
        };
        const elementHrefHasRequiredProtocol = (element) => {
            const hrefValue = element.getAttribute('href') || '';
            return is_regular_protocol_1.isRegularProtocol(hrefValue);
        };
        const hasTargetBlank = (element) => {
            if (normalize_string_1.normalizeString(element.getAttribute('target')) === '_blank') {
                return true;
            }
            debug('No `target="_blank"` found');
            return false;
        };
        const validate = ({ element, resource }) => {
            if (!hasTargetBlank(element) ||
                !hasHrefValue(element) ||
                !elementHrefHasRequiredProtocol(element) ||
                !checkSameOrigin(resource, element)) {
                return;
            }
            const relValuesToCheckFor = ['noopener'];
            if (!context.targetedBrowsers.length || !utils_compat_data_1.isSupported({ attribute: 'rel', element: 'link', value: 'noopener' }, context.targetedBrowsers)) {
                relValuesToCheckFor.push('noreferrer');
            }
            checkForRelValues(resource, element, relValuesToCheckFor);
        };
        loadHintConfigs();
        context.on('element::a', validate);
        context.on('element::area', validate);
    }
}
exports.default = DisownOpenerHint;
DisownOpenerHint.meta = meta_1.default;
